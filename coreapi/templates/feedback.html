{% extends "base.html" %}
{% load static %}
{% block title %}Site Feedback Form ‚Äî Vadrida{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/feedback.css' %}">
{% endblock %}

{% block content %}
<!-- Navigation Bar -->
<nav class="feedback-nav">
  <div class="nav-content">
    <div class="nav-left">
      <a href="{% url 'coreapi:dashboard' %}" class="nav-link back-link">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>
    <div class="nav-center">
      <h1 class="page-title">Site Feedback Form</h1>
    </div>
    <div class="nav-right">
      <span class="user-info">{{ request.session.user_name }}</span>
    </div>
  </div>
</nav>

<div id="orientationBlocker" class="orientation-blocker hidden">
  <div class="orientation-box">
    <h2>Rotate Device</h2>
    <p>This page works only in <b>landscape mode</b> on tablets.</p>
  </div>
</div>

<div class="relative">
  <!-- Loading overlay for Analyse action -->
  <div id="analyseLoading" class="loading-overlay hidden">
    <div class="spinner"></div>
    <div class="text-lg font-semibold">Analyzing ‚Äî please wait...</div>
    <div class="text-sm">Processing your file...</div>
  </div>

  <div class="feedback-layout">
    <!-- LEFT COLUMN: File List + Preview -->
    <div class="left-column">
      <!-- FILE LIST SECTION -->
      <section class="file-section">
        <div class="section-header">
          <h3 class="section-title">Files</h3>
          <button id="refreshFolders" class="refresh-btn">üîÑ</button>
        </div>

        <div class="file-controls">
          <input id="fileSearch" type="text" placeholder="Search file id or name..." class="search-input" />
          <div class="path-nav">
            <button id="goBackBtn" class="nav-btn">‚¨Ö</button>
            <span id="currentPath">/</span>
          </div>
        </div>

        <div class="file-list-container">
          <ul id="fileList" class="file-list"></ul>
        </div>

        <div class="file-info-panel">
          <h4 class="info-title">File Info</h4>
          <div id="fileInfoBox" class="info-content">
            Select a file to see details.
          </div>
        </div>
      </section>

      <!-- PREVIEW SECTION -->
      <section class="preview-section">
        <div class="section-header">
          <h3 class="section-title">Preview</h3>
          <div class="preview-controls">
            <button id="analyseBtn" class="analyse-btn">Analyse</button>
            <button id="openFullBtn" class="control-btn">Open Full</button>
          </div>
        </div>

        <div id="thumbs" class="thumbs-strip"></div>

        <div class="preview-container">
          <div class="preview-header">
            <div id="bigPreviewTitle" class="preview-title">No file selected</div>
            <button hidden id="downloadPdfBtn" class="download-btn hidden">
            
            </button>
          </div>

          <div id="bigViewer" class="preview-viewer">
            <div id="noSelection" class="no-selection">
              Select a file to preview
            </div>
            <div id="pdfWrapper" class="hidden pdf-container">
              <div id="pdfMain" class="pdf-scroll-container"></div>
            </div>
            <img id="bigImageFrame" class="hidden preview-image" src="" alt="preview" />
          </div>
        </div>
      </section>
    </div>

    <!-- RIGHT COLUMN: Comprehensive Feedback Form -->
    <div class="right-column">
      <div class="form-section">
        <div class="form-header">
          <h3 class="section-title">Site Feedback Form</h3>
        </div>

        <form id="siteFeedbackForm" class="feedback-form">
          
          <!-- Valuers Checklist -->
          <div class="form-section-group">
            <h4 class="form-section-title">Valuers Checklist</h4>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">1. Office File No.</label>
                <input type="number" data-path="Valuers.Office_file_no" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">2. Applicant Name</label>
                <input type="text" data-path="Valuers.applicant_name" class="form-input">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">3. Inspection Date</label>
                <input type="date" data-path="Valuers.inspection_date" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">4. Name of the person met at site</label>
                <input type="text" data-path="Valuers.person_met" class="form-input">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">5. Product</label>
              <select data-path="Valuers.product" class="form-select">
                <option value="notselected">Select Product</option>
                <option value="1st purchase">1st Purchase</option>
                <option value="construction">Construction</option>
                <option value="topup">Top Up</option>
                <option value="pd">PD</option>
                <option value="resale">Resale</option>
                <option value="renovation">Renovation</option>
                <option value="takeover">Takeover</option>
                <option value="lap">LAP</option>
                <option value="extension">Extension</option>
                <option value="npa">NPA</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">6. Documents Received</label>
              <div class="checkbox-grid">
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers.documents" value="Agreement"> Agreement</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers.documents" value="Encumbrance"> Encumbrance</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers.documents" value="Building Permit"> Building Permit</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers.documents" value="Declaration"> Declaration</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers.documents" value="Location Sketch"> Location Sketch</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers.documents" value="Development Permit"> Development Permit</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers.documents" value="Title Deed"> Title Deed</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers.documents" value="Survey Sketch"> Survey Sketch</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers.documents" value="Building Certificate"> Building Certificate</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers.documents" value="LTR"> LTR</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers.documents" value="Building Tax receipt"> Building Tax Receipt</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers.documents" value="Approved plan"> Approved Plan</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers.documents" value="Possession"> Possession</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers.documents" value="Engineers plan"> Engineers Plan</label>
              </div>
            </div>
          </div>

          <!-- I. Ownership Analysis -->
          <div class="form-section-group">
            <h4 class="form-section-title">I. Ownership Analysis</h4>
            
            <div class="form-group">
              <label class="form-label">1. Owner(s) Name</label>
              <input type="text" data-path="Ownership.owners_name" class="form-input">
            </div>
            
            <div class="form-group">
              <label class="form-label">Document Verification</label>
              <div class="checkbox-group">
                <label class="checkbox-label"><input type="checkbox" data-path="Ownership.ownership_check" value="same in all documents"> Same in all documents</label>
                <label class="checkbox-label"><input type="checkbox" data-path="Ownership.ownership_check" value="discrepancy noted"> Discrepancy noted</label>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea data-path="Ownership.notes" class="form-textarea" rows="4"></textarea>
            </div>
          </div>

          <!-- II. Survey Number and Land Extend Analysis -->
          <div class="form-section-group">
            <h4 class="form-section-title">II. Survey Number and Land Extend Analysis</h4>
            
            <div class="table-container" style="overflow-x: auto;">
                <table class="analysis-table survey-table" id="surveyTable">
                    <thead>
                        <tr id="surveyHeader">
                            <th style="min-width: 150px; position: sticky; left: 0; z-index: 10;">Doc Name</th>
                            </tr>
                    </thead>
                    <tbody id="surveyBody">
                        <tr data-row-key="scedule_no"><td>Scedule No</td></tr>
                        <tr data-row-key="re_sy_block"><td>Re-Sy Block No</td></tr>
                        <tr data-row-key="re_sy_no"><td>Re-Sy No</td></tr>
                        <tr data-row-key="re_sy_subdiv"><td>Re-Sy Subdiv No</td></tr>
                        <tr data-row-key="sy_block"><td>Sy Block No</td></tr>
                        <tr data-row-key="sy_no"><td>Sy No</td></tr>
                        <tr data-row-key="sy_subdiv"><td>Sy Subdiv No</td></tr>
                        <tr data-row-key="land_extent"><td>Land Extent (Ares)</td></tr>
                        <tr data-row-key="land_class"><td>Land Classification</td></tr>
                    </tbody>
                </table>
            </div>

            <button type="button" class="add-row-btn" onclick="addSurveyColumn()">
                + Add Survey Document Column
            </button>

            <div class="form-group mt-4">
                <label class="form-label">Notes, % of wetland and dry lands...</label>
                <textarea data-path="Survey.notes" class="form-textarea" rows="4"></textarea>
            </div>
        </div>
          <!-- III. Boundary Analysis and Property Identification -->
          <div class="form-section-group">
            <h4 class="form-section-title">III. Boundary Analysis and Property Identification</h4>
            
            <div class="table-container">
              <table class="analysis-table">
                <thead>
                  <tr>
                    <th>Direction</th>
                     <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Boundary.demarcation_north" value="no demarcation"> Title Deed</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Boundary.demarcation_north" value="gi sheet fence"> Location</label>
                     </td>
                      <th>Translation Reason if any</th>
                    <th>Site</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>North</td>
                    <td><input type="text" data-path="Boundary.north" class="table-input"></td>
                  
                    <td><input type="text" data-path="Boundary.north" class="table-input"></td>
                    <td><input type="text" data-path="Boundary.north" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>East</td>
                    <td><input type="text" data-path="Boundary.east" class="table-input"></td>
            
                    <td><input type="text" data-path="Boundary.east" class="table-input"></td>
                    <td><input type="text" data-path="Boundary.east" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>South</td>
                    <td><input type="text" data-path="Boundary.south" class="table-input"></td>
               
                    <td><input type="text" data-path="Boundary.south" class="table-input"></td>
                    <td><input type="text" data-path="Boundary.south" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>West</td>
                    <td><input type="text" data-path="Boundary.west" class="table-input"></td>
                
                    <td><input type="text" data-path="Boundary.west" class="table-input"></td>
                    <td><input type="text" data-path="Boundary.west" class="table-input"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="form-group">
              <label class="form-label">Notes if any/property identified with respect to documents..?</label>
              <textarea data-path="Boundary.boundary_notes" class="form-textarea" rows="4"></textarea>
            </div>
          </div>

          <!-- IV. Demarcations -->
          <div class="form-section-group">
            <h4 class="form-section-title">IV. Demarcations</h4>
            
            <div class="table-container">
              <table class="analysis-table">
                <thead>
                  <tr>
                    <th>Direction</th>
                    <th>Demarcation Type</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>North</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_north" value="no demarcation"> No demarcation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_north" value="gi sheet fence"> GI sheet fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_north" value="barbed wire"> Barbed wire</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_north" value="steel pegs"> Steel pegs</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_north" value="compound wall"> Compound wall</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_north" value="bio fence"> Bio fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_north" value="survey stone"> Survey stone</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_north" value="wooden pegs"> Wooden pegs</label>
                    </td>
                  </tr>
                  <tr>
                    <td>East</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_east" value="no demarcation"> No demarcation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_east" value="gi sheet fence"> GI sheet fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_east" value="barbed wire"> Barbed wire</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_east" value="steel pegs"> Steel pegs</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_east" value="compound wall"> Compound wall</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_east" value="bio fence"> Bio fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_east" value="survey stone"> Survey stone</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_east" value="wooden pegs"> Wooden pegs</label>
                    </td>
                  </tr>
                  <tr>
                    <td>South</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_south" value="no demarcation"> No demarcation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_south" value="gi sheet fence"> GI sheet fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_south" value="barbed wire"> Barbed wire</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_south" value="steel pegs"> Steel pegs</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_south" value="compound wall"> Compound wall</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_south" value="bio fence"> Bio fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_south" value="survey stone"> Survey stone</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_south" value="wooden pegs"> Wooden pegs</label>
                    </td>
                  </tr>
                  <tr>
                    <td>West</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_west" value="no demarcation"> No demarcation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_west" value="gi sheet fence"> GI sheet fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_west" value="barbed wire"> Barbed wire</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_west" value="steel pegs"> Steel pegs</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_west" value="compound wall"> Compound wall</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_west" value="bio fence"> Bio fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_west" value="survey stone"> Survey stone</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-path="Demarcation.demarcation_west" value="wooden pegs"> Wooden pegs</label>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="form-group">
              <label class="form-label">Notes if any</label>
              <textarea data-path="Demarcation.demarcation_notes" class="form-textarea" rows="3"></textarea>
            </div>

            <div class="form-group">
              <label class="form-label">Encroachment of subject building to neighbouring property, if any..?</label>
              <textarea data-path="Demarcation.subject_encroachment" class="form-textarea" rows="3"></textarea>
            </div>

            <div class="form-group">
              <label class="form-label">Encroachment of neighbour's building to subject property, if any..?</label>
              <textarea data-path="Demarcation.neighbor_encroachment" class="form-textarea" rows="3"></textarea>
            </div>
          </div>

          <!-- V. Access Nature/Right of Access -->
          <div class="form-section-group">
            <h4 class="form-section-title">V. Access Nature/Right of Access</h4>
            
            <div class="table-container">
              <table class="analysis-table access-table">
                <tbody>
                  <tr>
                    <td>1. Type of access as per title deed</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.access_deed" value="footway"> Footway</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.access_deed" value="panchayat rd"> Panchayat Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.access_deed" value="corporation rd"> Corporation Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.access_deed" value="national highway"> National Highway</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.access_deed" value="private way"> Private Way</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.access_deed" value="municipal rd"> Municipal Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.access_deed" value="pwd road"> PWD Road</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.access_deed" value="land locked"> Land Locked</label>
                    </td>
                  </tr>
                  <tr>
                    <td>2. Type of access as per site visit</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.access_site" value="footway"> Footway</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.access_site" value="panchayat rd"> Panchayat Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.access_site" value="corporation rd"> Corporation Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.access_site" value="national highway"> National Highway</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.access_site" value="private way"> Private Way</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.access_site" value="municipal rd"> Municipal Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.access_site" value="pwd road"> PWD Road</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.access_site" value="land locked"> Land Locked</label>
                    </td>
                  </tr>
                  <tr>
                    <td>3. If private way, no of users..?</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.private_users" value="self use"> Self use</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.private_users" value="self & 1 user"> Self & 1 user</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.private_users" value="self & 2 user"> Self & 2 user</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.private_users" value="self + family"> Self + family</label>
                    </td>
                  </tr>
                  <tr>
                    <td>4. Demarcation of private road</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.private_demarcation" value="no demarcation"> No demarcation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.private_demarcation" value="gi sheet fence"> GI sheet fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.private_demarcation" value="barbed wire"> Barbed wire</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.private_demarcation" value="steel pegs"> Steel pegs</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.private_demarcation" value="compound wall"> Compound wall</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.private_demarcation" value="bio fence"> Bio fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.private_demarcation" value="survey stone"> Survey stone</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.private_demarcation" value="wooden pegs"> Wooden pegs</label>
                    </td>
                  </tr>
                  <tr>
                    <td>5. Least width of main access in M</td>
                    <td><input type="number" step="0.01" data-path="Deed.main_access_width" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>6. Vehicular access</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.vehicular_access" value="pedestrian"> Pedestrian</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.vehicular_access" value="2-wheeler"> 2-wheeler</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.vehicular_access" value="3-wheeler"> 3-wheeler</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.vehicular_access" value="4-wheeler"> 4-wheeler</label>
                    </td>
                  </tr>
                  <tr>
                    <td>7. Least width of internal roads, in case of plot development</td>
                    <td><input type="number" step="0.01" data-path="Deed.internal_road_width" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>8. Weather the internal rd. abutting the subject plot has connectivity to main access as per deed..?</td>
                    <td><input type="text" data-path="Deed.internal_connectivity" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>9. Material of road</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.road_material" value="mud road"> Mud road</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.road_material" value="gravel road"> Gravel road</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.road_material" value="concrete road"> Concrete road</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.road_material" value="paving tile rd"> Paving tile rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Deed.road_material" value="tar road"> Tar road</label>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="form-group">
              <label class="form-label">Notes/Discrepancy if any..</label>
              <textarea data-path="Deed.access_notes" class="form-textarea" rows="4"></textarea>
            </div>
          </div>

          <!-- VI. For Purchase and Resale cases -->
          <div class="form-section-group">
            <h4 class="form-section-title">VI. For Purchase and Resale cases</h4>
            
            <div class="table-container">
              <table class="analysis-table">
                <tbody>
                  <tr>
                    <td>1. Buyer name</td>
                    <td><input type="text" data-path="Building.buyer_name" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>2. Seller name</td>
                    <td><input type="text" data-path="Building.seller_name" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>3. Relation b/w buyer and seller, if any</td>
                    <td><input type="text" data-path="Building.buyer_seller_relation" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>4. Since how long the property is up for sale..?</td>
                    <td><input type="text" data-path="Building.property_sale_duration" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>5. Brockers/OLX/99acers etc involved or how transaction happened..?</td>
                    <td><input type="text" data-path="Building.transaction_method" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>6. Land extend proposed for purchase..?</td>
                    <td><input type="text" data-path="Building.purchase_land_extent" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>7. Price asked</td>
                    <td><input type="number" data-path="Building.price_asked" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>8. Deal breaker value</td>
                    <td><input type="number" data-path="Building.deal_breaker_value" class="table-input"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="form-group">
              <label class="form-label">Notes/discrepancy if any..</label>
              <textarea data-path="Building.purchase_notes" class="form-textarea" rows="4"></textarea>
            </div>
          </div>

          <!-- VII. Building Analysis -->
          <div class="form-section-group">
            <h4 class="form-section-title">VII. Building Analysis</h4>
            
            <div class="table-container">
              <table class="analysis-table">
                <thead>
                  <tr>
                    <th>Floor No</th>
                    <th>Builtup Area (measured at site)</th>
                    <th>No. of Rooms</th>
                    <th>No. of Kitchen</th>
                    <th>No. of Bathrooms</th>
                    <th>Usage (Residential/Commercial/Industrial)</th>
                    <th>Occupancy (Owner/Applicant/Rented/Vacant)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>BF-2</td>
                    <td><input type="number" data-path="Building.BF-2Builtup" step="0.01" class="table-input"></td>
                    <td><input type="number" data-path="Building.BF-2Rooms" class="table-input"></td>
                    <td><input type="number" data-path="Building.BF-2Kitchen" class="table-input"></td>
                    <td><input type="number" data-path="Building.BF-2Bathrooms" class="table-input"></td>
                    <td><input type="text" data-path="Building.BF-2Usage" class="table-input"></td>
                    <td><input type="text" data-path="Building.BF-2Occupancy" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>BF-1</td>
                    <td><input type="number" data-path="Building.BF-1Builtup" step="0.01" class="table-input"></td>
                    <td><input type="number" data-path="Building.BF-1Rooms" class="table-input"></td>
                    <td><input type="number" data-path="Building.BF-1Kitchen" class="table-input"></td>
                    <td><input type="number" data-path="Building.BF-1Bathrooms" class="table-input"></td>
                    <td><input type="text" data-path="Building.BF-1Usage" class="table-input"></td>
                    <td><input type="text" data-path="Building.BF-1Occupancy" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>GF</td>
                    <td><input type="number" data-path="Building.GFBuiltup" step="0.01" class="table-input"></td>
                    <td><input type="number" data-path="Building.GFRooms" class="table-input"></td>
                    <td><input type="number" data-path="Building.GFKitchen" class="table-input"></td>
                    <td><input type="number" data-path="Building.GFBathrooms" class="table-input"></td>
                    <td><input type="text" data-path="Building.GFUsage" class="table-input"></td>
                    <td><input type="text" data-path="Building.GFOccupancy" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>1st Floor</td>
                    <td><input type="number" data-path="Building.1stBuiltup" step="0.01" class="table-input"></td>
                    <td><input type="number" data-path="Building.1stRooms" class="table-input"></td>
                    <td><input type="number" data-path="Building.1stKitchen" class="table-input"></td>
                    <td><input type="number" data-path="Building.1stBathrooms" class="table-input"></td>
                    <td><input type="text" data-path="Building.1stUsage" class="table-input"></td>
                    <td><input type="text" data-path="Building.1stOccupancy" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>2nd Floor</td>
                    <td><input type="number" data-path="Building.2ndBuiltup" step="0.01" class="table-input"></td>
                    <td><input type="number" data-path="Building.2ndRooms" class="table-input"></td>
                    <td><input type="number" data-path="Building.2ndKitchen" class="table-input"></td>
                    <td><input type="number" data-path="Building.2ndBathrooms" class="table-input"></td>
                    <td><input type="text" data-path="Building.2ndUsage" class="table-input"></td>
                    <td><input type="text" data-path="Building.2ndOccupancy" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>3rd Floor</td>
                    <td><input type="number" data-path="Building.3rdBuiltup" step="0.01" class="table-input"></td>
                    <td><input type="number" data-path="Building.3rdRooms" class="table-input"></td>
                    <td><input type="number" data-path="Building.3rdKitchen" class="table-input"></td>
                    <td><input type="number" data-path="Building.3rdBathrooms" class="table-input"></td>
                    <td><input type="text" data-path="Building.3rdUsage"  class="table-input"></td>
                    <td><input type="text" data-path="Building.3rdOccupancy" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>4th Floor</td>
                    <td><input type="number" data-path="Building.4thBuiltup" step="0.01" class="table-input"></td>
                    <td><input type="number" data-path="Building.4thRooms" class="table-input"></td>
                    <td><input type="number" data-path="Building.4thKitchen" class="table-input"></td>
                    <td><input type="number" data-path="Building.4thBathrooms" class="table-input"></td>
                    <td><input type="text" data-path="Building.4thUsage" class="table-input"></td>
                    <td><input type="text" data-path="Building.4thOccupancy" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>5th Floor</td>
                    <td><input type="number" data-path="Building.5thBuiltup" step="0.01" class="table-input"></td>
                    <td><input type="number" data-path="Building.5thRooms" class="table-input"></td>
                    <td><input type="number" data-path="Building.5thKitchen" class="table-input"></td>
                    <td><input type="number" data-path="Building.5thBathrooms" class="table-input"></td>
                    <td><input type="text" data-path="Building.5thUsage" class="table-input"></td>
                    <td><input type="text" data-path="Building.5thOccupancy" class="table-input"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="form-group">
              <label class="form-label">Notes/discrepancy in BUA/occupancy comparing site with respect to approved plan/permit etc if any..</label>
              <textarea data-path="Building.building_analysis_notes" class="form-textarea" rows="4"></textarea>
            </div>

            <!-- Roof Type Table -->
            <div class="table-container">
              <table class="analysis-table">
                <thead>
                  <tr>
                    <th>Roof Type</th>
                    <th> <label class="checkbox-label-small"><input type="checkbox" data-array="Building.roof_type" value="RCC"> RCC</label>
                     </th>
                    <th> <label class="checkbox-label-small"><input type="checkbox" data-array="Building.roof_type" value="Tiled">Tiled</label>
                     </th>
                    <th> <label class="checkbox-label-small"><input type="checkbox" data-array="Building.roof_type" value="Sheet"> Sheet</label>
                     </th>
                    <th> <label class="checkbox-label-small"><input type="checkbox" data-array="Building.roof_type" value="Other"> Other</label>
                     </th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Roof Percentage</td>
                    <td><input type="number" data-path="Building.RCCPer" step="0.01" class="table-input" placeholder="%"></td>
                    <td><input type="number" data-path="Building.TiledPer" step="0.01" class="table-input" placeholder="%"></td>
                    <td><input type="number" data-path="Building.SheetPer" step="0.01" class="table-input" placeholder="%"></td>
                    <td><input type="number" data-path="Building.OtherPer" step="0.01" class="table-input" placeholder="%"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Setback Table -->
            <div class="table-container">
                <table class="analysis-table">
                    <thead>
                    <tr>
                        <!-- Single column -->
                        <th rowspan="2">Setback (m)</th>

                        <!-- Yard headers -->
                        <th colspan="2">Front Yard</th>
                        <th colspan="2">Side-1 Yard</th>
                        <th colspan="2">Side-2 Yard</th>
                        <th colspan="2">Rear Yard</th>
                    </tr>
                    <tr>
                        <!-- Sub headers -->
                        <th>Min</th>
                        <th>Max</th>

                        <th>Min</th>
                        <th>Max</th>

                        <th>Min</th>
                        <th>Max</th>

                        <th>Min</th>
                        <th>Max</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr>
                        <!-- SINGLE setback input -->
                        <td>
                        <input
                            type="number"
                            data-path="Building.setback"
                            step="0.01"
                            class="table-input"
                            placeholder="Setback"
                        />
                        </td>

                        <!-- Front yard -->
                        <td><input type="number" data-path="Frontmin" step="0.01" class="table-input" /></td>
                        <td><input type="number" data-path="Frontmax" step="0.01" class="table-input" /></td>

                        <!-- Side-1 -->
                        <td><input type="number" data-path="S1min" step="0.01" class="table-input" /></td>
                        <td><input type="number" data-path="S1max" step="0.01" class="table-input" /></td>

                        <!-- Side-2 -->
                        <td><input type="number" data-path="S2min" step="0.01" class="table-input" /></td>
                        <td><input type="number" data-path="S2max" step="0.01" class="table-input" /></td>

                        <!-- Rear -->
                        <td><input type="number" data-path="Rearmin" step="0.01" class="table-input" /></td>
                        <td><input type="number" data-path="Rearmax" step="0.01" class="table-input" /></td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Construction Timeline Table -->
            <div class="table-container">
              <table class="analysis-table">
                <tbody>
                  <tr>
                    <td>Year of construction of foundation, other floors etc, if constructed in different timelines</td>
                    <td><input type="text" data-path="Building.construction_timeline" class="table-input"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="form-group">
              <label class="form-label">Notes/no of carparks/wardrobes/kitchen cabinets/flooring material/interior decorations, any other amenities..?</label>
              <textarea data-path="Building.amenities_notes" class="form-textarea" rows="4"></textarea>
            </div>
          </div>

          <!-- VIII. Landmark and Layout (Handsketch) -->
          <div class="form-section-group">
            <h4 class="form-section-title">VIII. Landmark and Layout (Handsketch)</h4>
            
            <div class="form-group">
              <label class="form-label">Landmark</label>
              <textarea data-path="Sketch.landmark_description" class="form-textarea" rows="3"></textarea>
            </div>

            <div class="sketch-container">
              <div class="sketch-header">
                <span>Drawing Area</span>
                <div class="compass">
                  <div class="compass-circle">
                    <div class="compass-point north">N</div>
                    <div class="compass-point east">E</div>
                    <div class="compass-point south">S</div>
                    <div class="compass-point west">W</div>
                  </div>
                </div>
              </div>
              <canvas id="sketchCanvas" class="sketch-canvas" width="600" height="400"></canvas>
              <div class="sketch-controls">
                <button type="button" id="clearCanvas" class="sketch-btn">Clear</button>
                <button type="button" id="undoCanvas" class="sketch-btn">Undo</button>
                <input type="color" id="colorPicker" value="#000000" class="color-picker">
                <input type="range" id="brushSize" min="1" max="10" value="2" class="brush-size">
                <span class="brush-label">Brush Size</span>
              </div>
            </div>
          </div>

          <button type="submit" class="submit-btn">Submit Feedback</button>
          <button type="button" 
                  onclick="localStorage.removeItem('vadrida_site_feedback_autosave'); location.reload();" 
                  style="background: #ef4444; color: white; padding: 10px; margin-top: 10px;">
              ‚ö†Ô∏è Reset Form Data (Fix Stuck State)
          </button>
        </form>

      </div>
    </div>
  </div>
</div>

<!-- All modals remain the same -->
<div id="fullscreenModal" aria-hidden="true">
  <div class="modal-box">
    <div class="modal-header">
      <div id="modalTitle" class="modal-title">Preview</div>
      <div class="modal-controls">
        <div id="shareButtonsContainer" class="share-buttons hidden">
          <a href="#" id="shareWhatsapp" class="share-btn">
            <i class="fab fa-whatsapp mr-2"></i>WhatsApp
          </a>
          <a href="#" id="shareTelegram" class="share-btn">
            <i class="fab fa-telegram mr-2"></i>Telegram
          </a>
          <a href="#" id="shareEmail" class="share-btn">
            <i class="fas fa-envelope mr-2"></i>Email
          </a>
          <a href="#" id="shareCopy" class="share-btn">
            <i class="fas fa-link mr-2"></i>Copy Link
          </a>
        </div>
        <a id="modalShare" href="#" class="share-btn">
          <i class="fas fa-share-alt mr-2"></i>Share
        </a>
        <button id="modalDownloadBtn" class="download-btn">
          <i class="fas fa-file-download mr-2"></i>Download
        </button>
        <button id="modalClose" class="control-btn">Close</button>
      </div>
    </div>
    <div id="modalBody" class="modal-body">
      <iframe id="modalFrame" class="hidden" src=""></iframe>
      <img id="modalImage" class="hidden" src="" alt="preview" />
    </div>
  </div>
</div>

<div id="analyseModal" class="modal hidden">
  <div class="modal-content">
    <h2 class="modal-title">Analyse Files</h2>
    <p class="modal-text">Choose files for analysis</p>
    <button id="analyseSelectFiles" class="modal-btn primary">Select Files</button>
    <button id="analyseSelectAll" class="modal-btn success">Select All Files</button>
    <button id="analyseClose" class="modal-btn">Cancel</button>
  </div>
</div>

<div id="fileSelectModal" class="modal hidden">
  <div class="modal-content">
    <h2 class="modal-title">Select Files</h2>
    <div id="fileSelectList" class="file-select-list"></div>
    <button id="confirmFileSelection" class="modal-btn primary">Confirm Selection</button>
    <button id="fileSelectClose" class="modal-btn">Cancel</button>
  </div>
</div>



<script>
/* =========================
   CSRF
========================= */
function getCookie(name) {
  let v = null;
  document.cookie?.split(";").forEach(c => {
    c = c.trim();
    if (c.startsWith(name + "=")) v = decodeURIComponent(c.slice(name.length + 1));
  });
  return v;
}
const csrftoken = getCookie("csrftoken");

/* =========================
   ELEMENTS
========================= */
const fileList = document.getElementById("fileList");
const thumbsContainer = document.getElementById("thumbs");
const bigImageFrame = document.getElementById("bigImageFrame");
const noSelection = document.getElementById("noSelection");
const bigPreviewTitle = document.getElementById("bigPreviewTitle");
const openModalBtn = document.getElementById("openFullBtn");
const fileInfoBox = document.getElementById("fileInfoBox");
const pdfWrapper = document.getElementById("pdfWrapper");
const pdfMain = document.getElementById("pdfMain");

/* =========================
   STATE
========================= */
let currentFolder = "";
let currentFile = null;
let analysisController = null;
let currentFolderFiles = [];
let selectedAnalysisFiles = [];
let rootFoldersCache = null;
let isSearching = false;
let currentPreviewUrl = null;

/* =========================
   FOLDER LOADER
========================= */
function loadFolder(path = "") {
  currentFolder = path;
  document.getElementById("currentPath").textContent = "/" + (path || "");
  
  // Show loading state
  fileList.innerHTML = `<li class="file-item loading">Loading...</li>`;
  thumbsContainer.innerHTML = `<div class="no-thumbs">Loading...</div>`;

  console.log("Loading folder:", path); // Debug log

  fetch(`/coreapi/api/folder-contents/?path=${encodeURIComponent(path)}`)
    .then(response => {
      console.log("Response status:", response.status); // Debug log
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      console.log("Received data:", data); // Debug log
      currentFolderFiles = data.files || [];
      renderFileList(data.folders || [], data.files || []);
      renderThumbs(data.files || []);
    })
    .catch(error => {
      console.error("Error loading folder:", error);
      fileList.innerHTML = `<li class="file-item error">Error loading folder: ${error.message}</li>`;
      thumbsContainer.innerHTML = `<div class="no-thumbs">Error loading files</div>`;
    });
}

document.getElementById("goBackBtn").onclick = () => {
  if (!currentFolder) return;
  const parts = currentFolder.split("/");
  parts.pop();
  loadFolder(parts.join("/"));
};

/* =========================
   FILE LIST
========================= */
function renderFileList(folders, files) {
  console.log("Rendering file list - Folders:", folders.length, "Files:", files.length); // Debug log
  
  fileList.innerHTML = "";

  // Render folders first
  folders.forEach(folder => {
    const li = document.createElement("li");
    li.className = "file-item folder-item";
    li.innerHTML = `üìÅ <strong>${folder.name}</strong>`;
    li.onclick = () => {
      console.log("Clicking folder:", folder.path); // Debug log
      loadFolder(folder.path);
    };
    fileList.appendChild(li);
  });

  // Render files
  files.forEach(file => {
    const li = document.createElement("li");
    li.className = "file-item";
    li.innerHTML = `
      <div class="file-details">
        <div class="file-name">${file.name}</div>
        <div class="file-ext">${file.extension || ""}</div>
      </div>
    `;

    li.onclick = () => {
      console.log("Clicking file:", file.name); // Debug log
      document.querySelectorAll(".file-item").forEach(el => el.classList.remove("selected"));
      li.classList.add("selected");
      loadBigPreview(file);
      setFileInfo(file);
    };

    fileList.appendChild(li);
  });

  // Show message if no items
  if (!folders.length && !files.length) {
    fileList.innerHTML = `<li class="no-results">No files or folders found</li>`;
  }
}

/* =========================
   THUMBNAILS
========================= */
async function renderPdfThumbnail(file, container) {
  try {
    await loadPdfJsIfNeeded();

    const url = `/coreapi/serve-file/?path=${encodeURIComponent(file.path)}`;
    const pdf = await pdfjsLib.getDocument(url).promise;
    const page = await pdf.getPage(1);

    const viewport = page.getViewport({ scale: 0.3 });
    const canvas = document.createElement("canvas");
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({
      canvasContext: canvas.getContext("2d"),
      viewport
    }).promise;

    container.appendChild(canvas);
  } catch (error) {
    console.error("Error rendering PDF thumbnail:", error);
    container.innerHTML = `
      <div class="file-icon">
        <i class="fas fa-file-pdf"></i><br>PDF
      </div>
    `;
  }
}

async function renderThumbs(files) {
  console.log("Rendering thumbnails for", files.length, "files"); // Debug log
  
  thumbsContainer.innerHTML = "";

  if (!files.length) {
    thumbsContainer.innerHTML = `<div class="no-thumbs">No files to preview</div>`;
    return;
  }

  for (const file of files) {
    const card = document.createElement("div");
    card.className = "thumb-item";

    const ext = file.name.split(".").pop().toLowerCase();

    if (["jpg","jpeg","png","gif","bmp","webp"].includes(ext)) {
      const img = document.createElement("img");
      img.src = `/coreapi/serve-file/?path=${encodeURIComponent(file.path)}`;
      img.loading = "lazy";
      img.onerror = () => {
        card.innerHTML = `
          <div class="file-icon">
            <i class="fas fa-image"></i><br>${ext.toUpperCase()}
          </div>
        `;
      };
      card.appendChild(img);
    }
    else if (ext === "pdf") {
      await renderPdfThumbnail(file, card);
    }
    else {
      card.innerHTML = `
        <div class="file-icon">
          <i class="fas fa-file"></i><br>${ext.toUpperCase()}
        </div>
      `;
    }

    card.onclick = () => {
      console.log("Clicking thumbnail for:", file.name); // Debug log
      loadBigPreview(file);
    };
    thumbsContainer.appendChild(card);
  }
}

/* =========================
   PREVIEW
========================= */
function loadBigPreview(file) {
  console.log("Loading preview for:", file.name); // Debug log
  currentFile = file;

  // Hard reset
  pdfMain.innerHTML = "";
  pdfWrapper.classList.add("hidden");
  bigImageFrame.classList.add("hidden");
  noSelection.classList.add("hidden");
  bigImageFrame.src = "";

  const url = `/coreapi/serve-file/?path=${encodeURIComponent(file.path)}`;
  currentPreviewUrl = url;
  bigPreviewTitle.textContent = file.name;

  const ext = file.name.split(".").pop().toLowerCase();

  // IMAGE
  if (["jpg","jpeg","png","gif","bmp","webp"].includes(ext)) {
    bigImageFrame.src = url;
    bigImageFrame.onload = () => {
      bigImageFrame.classList.remove("hidden");
      document.getElementById("downloadPdfBtn").classList.remove("hidden");
    };
    bigImageFrame.onerror = () => {
      noSelection.textContent = "Error loading image";
      noSelection.classList.remove("hidden");
    };
    return;
  }

  // PDF
  if (ext === "pdf") {
    pdfWrapper.classList.remove("hidden");
    document.getElementById("downloadPdfBtn").classList.remove("hidden");
    renderFullPdf(url);
    return;
  }

  // OTHER FILES
  noSelection.textContent = "Preview not available for this file type";
  noSelection.classList.remove("hidden");
  document.getElementById("downloadPdfBtn").classList.add("hidden");
}

/* =========================
   FILE INFO
========================= */
function setFileInfo(file) {
  fileInfoBox.innerHTML = `
    <div class="info-row"><strong>Name:</strong> <span>${file.name}</span></div>
    <div class="info-row"><strong>Type:</strong> ${file.extension || "Unknown"}</div>
    <div class="info-row"><strong>Size:</strong> ${file.size || "N/A"}</div>
    <div class="info-row"><strong>Path:</strong> <span>${file.path || "N/A"}</span></div>
  `;
}

/* =========================
   ANALYSE
========================= */
function startAnalysis(files) {
  if (analysisController) {
    analysisController.abort();
  }

  analysisController = new AbortController();
  document.getElementById("analyseLoading").classList.remove("hidden");

  fetch("/coreapi/api/analyze/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrftoken
    },
    body: JSON.stringify({ files, folder: currentFolder }),
    signal: analysisController.signal
  })
  .then(r => {
    if (!r.ok) {
      throw new Error(`HTTP ${r.status}: ${r.statusText}`);
    }
    return r.json();
  })
  .then(() => {
    console.log("Analysis completed");
    loadFolder(currentFolder);
  })
  .catch(error => {
    if (error.name !== 'AbortError') {
      console.error("Analysis error:", error);
      alert("Analysis failed: " + error.message);
    }
  })
  .finally(() => {
    document.getElementById("analyseLoading").classList.add("hidden");
    analysisController = null;
  });
}

const analyseBtn = document.getElementById("analyseBtn");
const analyseModal = document.getElementById("analyseModal");

analyseBtn.onclick = () => {
  if (!currentFolder && currentFolderFiles.length === 0) {
    alert("No files available for analysis");
    return;
  }
  analyseModal.classList.remove("hidden");
};

document.getElementById("analyseSelectAll").onclick = () => {
  if (!currentFolderFiles.length) {
    alert("No files in current location");
    return;
  }

  const files = currentFolderFiles.map(f => ({ file_path: f.path }));
  analyseModal.classList.add("hidden");
  startAnalysis(files);
};

const fileSelectModal = document.getElementById("fileSelectModal");
const fileSelectList = document.getElementById("fileSelectList");

document.getElementById("analyseSelectFiles").onclick = () => {
  if (!currentFolderFiles.length) {
    alert("No files in current location");
    return;
  }

  fileSelectList.innerHTML = "";
  selectedAnalysisFiles = [];

  currentFolderFiles.forEach(file => {
    const row = document.createElement("label");
    row.className = "flex items-center gap-2 mb-2 cursor-pointer";
    row.innerHTML = `
      <input type="checkbox" value="${file.path}" />
      <span class="truncate">${file.name}</span>
    `;

    const checkbox = row.querySelector("input");
    checkbox.onchange = () => {
      if (checkbox.checked) {
        selectedAnalysisFiles.push({ file_path: checkbox.value });
      } else {
        selectedAnalysisFiles = selectedAnalysisFiles.filter(f => f.file_path !== checkbox.value);
      }
    };

    fileSelectList.appendChild(row);
  });

  analyseModal.classList.add("hidden");
  fileSelectModal.classList.remove("hidden");
};

document.getElementById("confirmFileSelection").onclick = () => {
  if (!selectedAnalysisFiles.length) {
    alert("Select at least one file");
    return;
  }

  fileSelectModal.classList.add("hidden");
  startAnalysis(selectedAnalysisFiles);
};

document.getElementById("analyseClose").onclick = () => {
  analyseModal.classList.add("hidden");
};

document.getElementById("fileSelectClose").onclick = () => {
  fileSelectModal.classList.add("hidden");
};

/* =========================
   FILE SEARCH
========================= */
const searchInput = document.getElementById("fileSearch");
let searchTimer = null;

searchInput.addEventListener("input", e => {
  const q = e.target.value.trim();
  clearTimeout(searchTimer);

  searchTimer = setTimeout(() => {
    if (!q) {
      isSearching = false;
      if (rootFoldersCache) {
        renderFileList(rootFoldersCache.folders || [], rootFoldersCache.files || []);
        renderThumbs(rootFoldersCache.files || []);
      } else {
        loadFolder(currentFolder);
      }
      return;
    }

    globalSearch(q);
  }, 300);
});

/* =========================
   RENDER FULL PDF - ENHANCED WITH SCROLLING
========================= */
async function renderFullPdf(url) {
  try {
    await loadPdfJsIfNeeded();

    const pdf = await pdfjsLib.getDocument(url).promise;
    pdfMain.innerHTML = "";

    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const scale = window.innerWidth < 768 ? 1.2 : 1.5;
      const viewport = page.getViewport({ scale });

      const canvas = document.createElement("canvas");
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      canvas.style.marginBottom = "10px";
      canvas.style.display = "block";
      canvas.style.border = "1px solid #e5e7eb";

      await page.render({
        canvasContext: canvas.getContext("2d"),
        viewport
      }).promise;

      pdfMain.appendChild(canvas);
    }
    
    // Ensure PDF container is scrollable
    pdfMain.style.overflowY = "auto";
    pdfMain.style.maxHeight = "100%";
    
  } catch (error) {
    console.error("Error rendering PDF:", error);
    pdfMain.innerHTML = `<div class="error">Error loading PDF: ${error.message}</div>`;
  }
}

/* =========================
   PDF.JS LOADER
========================= */
function loadPdfJsIfNeeded() {
  if (window.pdfjsLib) return Promise.resolve();

  return new Promise((resolve, reject) => {
    const script = document.createElement("script");
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";

    script.onload = () => {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      resolve();
    };

    script.onerror = () => {
      console.error("Failed to load PDF.js");
      reject(new Error("Failed to load PDF.js"));
    };
    document.head.appendChild(script);
  });
}

/* =========================
   GLOBAL SEARCH
========================= */
function globalSearch(query) {
  isSearching = true;
  fileList.innerHTML = `<li class="file-item loading">Searching...</li>`;
  thumbsContainer.innerHTML = `<div class="no-thumbs">Searching...</div>`;

  fetch(`/coreapi/api/search/?q=${encodeURIComponent(query)}`)
    .then(r => {
      if (!r.ok) {
        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      }
      return r.json();
    })
    .then(data => {
      console.log("Search results:", data);
      renderFileList(data.folders || [], data.files || []);
      renderThumbs(data.files || []);
    })
    .catch(error => {
      console.error("Search error:", error);
      fileList.innerHTML = `<li class="file-item error">Search failed: ${error.message}</li>`;
      thumbsContainer.innerHTML = `<div class="no-thumbs">Search failed</div>`;
    });
}

/* =========================
   REFRESH
========================= */
document.getElementById("refreshFolders").onclick = () => {
  console.log("Refreshing folders");
  fetch("/coreapi/api/refresh/", {
    method: "POST",
    headers: {
      "X-CSRFToken": csrftoken
    }
  })
  .then(r => {
    if (!r.ok) {
      throw new Error(`HTTP ${r.status}: ${r.statusText}`);
    }
    return r.json();
  })
  .then(() => {
    rootFoldersCache = null;
    searchInput.value = "";
    currentFolder = "";
    loadFolder("");
  })
  .catch(error => {
    console.error("Refresh error:", error);
    alert("Refresh failed: " + error.message);
  });
};

/* =========================
   FULLSCREEN MODAL
========================= */
const fullscreenModal = document.getElementById("fullscreenModal");
const modalFrame = document.getElementById("modalFrame");
const modalImage = document.getElementById("modalImage");

document.getElementById("openFullBtn").onclick = () => {
  if (!currentFile || !currentPreviewUrl) {
    alert("Select a file first");
    return;
  }
  const ext = currentFile.name.split(".").pop().toLowerCase();

  // Mobile ‚Üí open native viewer
  if (window.innerWidth < 768) {
    window.open(currentPreviewUrl, "_blank");
    return;
  }

  // Desktop ‚Üí modal
  fullscreenModal.setAttribute("aria-hidden", "false");
  modalFrame.classList.add("hidden");
  modalImage.classList.add("hidden");

  if (["jpg","jpeg","png","gif","bmp","webp"].includes(ext)) {
    modalImage.src = currentPreviewUrl;
    modalImage.classList.remove("hidden");
  } else {
    modalFrame.src = currentPreviewUrl;
    modalFrame.classList.remove("hidden");
  }
};

document.getElementById("modalClose").onclick = () => {
  fullscreenModal.setAttribute("aria-hidden", "true");
  modalFrame.src = "";
  modalImage.src = "";
};

/* =========================
   SHARE & DOWNLOAD
========================= */
const modalShareBtn = document.getElementById("modalShare");
const shareButtonsContainer = document.getElementById("shareButtonsContainer");

modalShareBtn.onclick = async (e) => {
  e.preventDefault();

  if (navigator.share && currentPreviewUrl) {
    try {
      await navigator.share({
        title: "Document",
        url: window.location.origin + currentPreviewUrl
      });
    } catch (error) {
      console.log("Share failed:", error);
    }
  } else {
    shareButtonsContainer.classList.toggle("hidden");
  }
};

function updateShareLinks(url) {
  const encoded = encodeURIComponent(window.location.origin + url);

  document.getElementById("shareWhatsapp").href = `https://wa.me/?text=${encoded}`;
  document.getElementById("shareTelegram").href = `https://t.me/share/url?url=${encoded}`;
  document.getElementById("shareEmail").href = `mailto:?subject=Document&body=${encoded}`;

  document.getElementById("shareCopy").onclick = (e) => {
    e.preventDefault();
    navigator.clipboard.writeText(window.location.origin + url).then(() => {
      alert("Link copied to clipboard");
    }).catch(error => {
      console.error("Copy failed:", error);
      alert("Failed to copy link");
    });
  };
}

const modalDownloadBtn = document.getElementById("modalDownloadBtn");

modalDownloadBtn.onclick = () => {
  if (!currentFile) {
    alert("No file selected");
    return;
  }

  const downloadUrl = `/coreapi/serve-file/?path=${encodeURIComponent(currentFile.path)}&download=true`;
  window.location.href = downloadUrl;
};

/* =========================
   INIT
========================= */
document.addEventListener("DOMContentLoaded", () => {
  console.log("Dashboard JS loaded");
  loadFolder("");
});

// enforce landscape 

function enforceTabletLandscape() {
  const isTablet = window.innerWidth >= 768 && window.innerWidth <= 1024;
  const isPortrait = window.innerHeight > window.innerWidth;

  const blocker = document.getElementById("orientationBlocker");

  if (isTablet && isPortrait) {
    blocker.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  } else {
    blocker.classList.add("hidden");
    document.body.style.overflow = "";
  }
}

window.addEventListener("resize", enforceTabletLandscape);
window.addEventListener("orientationchange", enforceTabletLandscape);
document.addEventListener("DOMContentLoaded", enforceTabletLandscape);


// sketch............

const canvas = document.getElementById("sketchCanvas");
const ctx = canvas.getContext("2d");

let drawing = false;
let history = [];
let brushColor = "#000";
let brushSize = 2;

function saveState() {
  history.push(canvas.toDataURL());
  if (history.length > 20) history.shift();
}

canvas.addEventListener("mousedown", e => {
  drawing = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
  saveState();
});

canvas.addEventListener("mousemove", e => {
  if (!drawing) return;
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.strokeStyle = brushColor;
  ctx.lineWidth = brushSize;
  ctx.lineCap = "round";
  ctx.stroke();
});

canvas.addEventListener("mouseup", () => {
  drawing = false;
  ctx.closePath();
});

document.getElementById("clearCanvas").onclick = () => {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
};

document.getElementById("undoCanvas").onclick = () => {
  if (!history.length) return;
  const img = new Image();
  img.src = history.pop();
  img.onload = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);
  };
};

document.getElementById("colorPicker").onchange = e => {
  brushColor = e.target.value;
};

document.getElementById("brushSize").oninput = e => {
  brushSize = e.target.value;
};




/* =========================
   FORM STATE & AUTOSAVE
========================= */
let formState = {
    // Combine everything into Capital 'Valuers'
    Valuers: {
        documents: [], // This holds the checkbox values
        product: "",
        Office_file_no: "",
        applicant_name: "",
        inspection_date: "",
        person_met: ""
    },
    // ... rest of your state (Ownership, Survey, etc.)
    Ownership: { ownership_check: [], notes: "", owners_name: "" },
    Survey: { docs: [], notes: "" },
    Boundary: {},
    Demarcation: {},
    Deed: {
        access_deed: [], access_site: [], private_users: [],
        private_demarcation: [], vehicular_access: [], road_material: []
    },
    Building: { roof_type: [], setback: "" },
    Sketch: {},
    
    // Root level variables (for Setback table)
    Frontmin: "", Frontmax: "",
    S1min: "", S1max: "",
    S2min: "", S2max: "",
    Rearmin: "", Rearmax: "",
    
    sketch_data: null
};
const STORAGE_KEY = 'vadrida_site_feedback_autosave';

// Initialize
document.addEventListener("DOMContentLoaded", () => {
    console.log("Dashboard JS loaded");
    
    // 1. Load Folder logic (Keep your existing logic here)
    loadFolder("");
    enforceTabletLandscape();

    // 2. Load Form State
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            // Merge carefully to preserve structure
            formState = { ...formState, ...parsed };
            
            // Fix for survey docs if missing
            if (!Array.isArray(formState.survey.docs)) {
                formState.survey.docs = [];
            }
        }
    } catch (e) {
        console.error("Corrupt save data, resetting:", e);
        localStorage.removeItem(STORAGE_KEY);
    }

    // 3. Render the Dynamic Table FIRST 
    // (This creates the DOM elements for the survey columns based on state)
    try {
        renderSurveyColumns(); 
    } catch (e) {
        console.error("Table render failed:", e);
    }

    // 4. NOW Sync the rest of the UI (Inputs, Checkboxes, Canvas)
    // This fills the static fields and checkboxes
    try {
        syncStateToUI(); 
    } catch (e) {
        console.error("UI Sync failed:", e);
    }
});




/* =========================
   STATE SYNC UTILITIES
   (Add this before DOMContentLoaded)
========================= */

// Helper to safely get deep values (e.g., "Valuers.applicant_name")
function getNestedValue(obj, path) {
    if (!path) return undefined;
    return path.split('.').reduce((acc, part) => (acc && acc[part] !== undefined) ? acc[part] : undefined, obj);
}

function syncStateToUI() {
    console.log("Syncing State to UI...", formState);

    // 1. Handle Standard Inputs (Text, Number, Date, Selects, Radio) bound by data-path
    document.querySelectorAll('[data-path]').forEach(el => {
        const path = el.getAttribute('data-path');
        const value = getNestedValue(formState, path);

        if (value !== undefined && value !== null) {
            if (el.type === 'checkbox') {
                // If it's a checkbox using data-path (boolean or specific string match)
                if (Array.isArray(value)) {
                    // Edge case: if user used data-path for an array accidentally
                    el.checked = value.includes(el.value);
                } else {
                    el.checked = (el.value === value) || (value === true);
                }
            } else if (el.type === 'radio') {
                el.checked = (el.value === value);
            } else {
                // Standard inputs
                el.value = value;
            }
        }
    });

    // 2. Handle Multi-Select Checkboxes bound by data-array
    document.querySelectorAll('[data-array]').forEach(el => {
        const path = el.getAttribute('data-array');
        const arr = getNestedValue(formState, path);
        
        if (Array.isArray(arr) && arr.includes(el.value)) {
            el.checked = true;
        }
    });

    // 3. Restore Sketch/Canvas
    if (formState.sketch_data) {
        const canvas = document.getElementById("sketchCanvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();
        img.onload = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
        };
        img.src = formState.sketch_data;
    }
}




// Update State from standard inputs
document.getElementById('siteFeedbackForm').addEventListener('input', (e) => {
    const target = e.target;
    const path = target.getAttribute('data-path');
    const arrayPath = target.getAttribute('data-array');
    
    if (path) {
        updateNestedState(formState, path, target.value);
    } else if (arrayPath) {
        updateArrayState(formState, arrayPath, target.value, target.checked);
    }
    
    localStorage.setItem(STORAGE_KEY, JSON.stringify(formState));
});

/* =========================
   DYNAMIC SURVEY TABLE LOGIC
========================= */
function addSurveyColumn() {
    // Changed formState.survey -> formState.Survey (Capital S)
    if (formState.Survey.docs.length >= 20) return alert("Max 20 documents allowed");
    
    formState.Survey.docs.push({
        name: `Doc ${formState.Survey.docs.length + 1}`,
        scedule_no: "", re_sy_block: "", re_sy_no: "", re_sy_subdiv: "",
        sy_block: "", sy_no: "", sy_subdiv: "",
        land_extent: "", land_class: ""
    });
    
    renderSurveyColumns();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(formState));
}


function renderSurveyColumns() {
    const headerRow = document.getElementById('surveyHeader');
    const bodyRows = document.querySelectorAll('#surveyBody tr');

    if (!headerRow || bodyRows.length === 0) return;

    // 1. Clear existing dynamic cells
    headerRow.querySelectorAll('.dyn-col').forEach(el => el.remove());
    bodyRows.forEach(row => row.querySelectorAll('.dyn-cell').forEach(el => el.remove()));

    // 2. SAFELY get the documents list using Capital 'V'
    // This looks into formState.Valuers.documents
    const availableDocs = (formState.Valuers && formState.Valuers.documents) ? formState.Valuers.documents : [];

    // 3. Render Columns
    // Ensure formState.Survey exists
    if (!formState.Survey || !formState.Survey.docs) return;

    formState.Survey.docs.forEach((doc, index) => {
        let optionsHtml = '<option value="">Select Document</option>';
        
        // Populate dropdown with checked items
        availableDocs.forEach(docName => {
            const isSelected = (doc.name === docName) ? 'selected' : '';
            optionsHtml += `<option value="${docName}" ${isSelected}>${docName}</option>`;
        });

        // Create Header (Dropdown)
        const th = document.createElement('th');
        th.className = 'dyn-col';
        th.style.minWidth = "150px";
        th.innerHTML = `
            <select class="form-select" style="width: 100%; color:black;"
                    onchange="updateSurveyDoc(${index}, 'name', this.value)">
                ${optionsHtml}
            </select>
        `;
        headerRow.appendChild(th);

        // Create Body Cells (Inputs)
        bodyRows.forEach(row => {
            const key = row.getAttribute('data-row-key');
            if(key) {
                const td = document.createElement('td');
                td.className = 'dyn-cell';
                td.innerHTML = `
                    <input type="text" class="table-input" 
                           value="${doc[key] || ''}" 
                           oninput="updateSurveyDoc(${index}, '${key}', this.value)">
                `;
                row.appendChild(td);
            }
        });
    });
}

function updateSurveyDoc(index, key, value) {
    // Changed formState.survey -> formState.Survey (Capital S)
    formState.Survey.docs[index][key] = value;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(formState));
}

// dropdown from checkbox logic 
document.getElementById('siteFeedbackForm').addEventListener('input', (e) => {
    const target = e.target;
    const path = target.getAttribute('data-path');
    const arrayPath = target.getAttribute('data-array');
    
    // 1. Update State
    if (path) {
        updateNestedState(formState, path, target.value);
    } else if (arrayPath) {
        // Handle Checkboxes
        // Note: target.checked returns true/false
        updateArrayState(formState, arrayPath, target.value, target.checked);
        
        // 2. TRIGGER RE-RENDER
        // Check if the changed item was "Valuers.documents" (Capital V)
        if (arrayPath === 'Valuers.documents') {
            console.log("Documents changed, re-rendering table..."); // Debug line
            renderSurveyColumns();
        }
    }
    
    // 3. Autosave
    localStorage.setItem(STORAGE_KEY, JSON.stringify(formState));
});

/* =========================
   UTILITIES & SUBMISSION
========================= */
function updateNestedState(obj, path, value) {
    const keys = path.split('.');
    let current = obj;
    while (keys.length > 1) {
        const k = keys.shift();
        current[k] = current[k] || {};
        current = current[k];
    }
    current[keys[0]] = value;
}

function updateArrayState(obj, path, value, isChecked) {
    const keys = path.split('.');
    let current = obj;
    while (keys.length > 1) {
        const k = keys.shift();
        current[k] = current[k] || {};
        current = current[k];
    }
    const lastKey = keys[0];
    current[lastKey] = current[lastKey] || [];
    if (isChecked) {
        if (!current[lastKey].includes(value)) current[lastKey].push(value);
    } else {
        current[lastKey] = current[lastKey].filter(v => v !== value);
    }
}

// Submit to Django
document.getElementById('siteFeedbackForm').onsubmit = async (e) => {
    e.preventDefault();
    
    // Add Sketch data
    const canvas = document.getElementById("sketchCanvas");
    formState.sketch_data = canvas.toDataURL();

    const response = await fetch('/coreapi/api/save-feedback/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        credentials:'include',
        body: JSON.stringify(formState)
    });

    const res = await response.json();
    if(res.success) {
        alert("Saved Successfully");
        localStorage.removeItem(STORAGE_KEY);
    }
};


</script>


{% endblock %}